<%- include('../partials/headers', { title: `User Details - ${user.first_name} ${user.last_name}` }) %>
<%- include('../partials/sidebar', { title: "Users" }) %>

<div class="content-wrapper">
  <!-- Page Header -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2 align-items-center">
        <div class="col-sm-6">
          <h1 class="m-0">User Details</h1>
        </div>
        <div class="col-sm-6 text-end">
          <a href="/admin/users" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Back
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Success Message -->
  <% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success text-center mx-3"><%= success %></div>
  <% } %>

  <!-- Error Messages -->
  <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
    <div class="alert alert-danger mx-3">
      <ul class="mb-0">
        <% errors.forEach(err => { %>
          <li><%= err %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>

  <!-- Main Content -->
  <section class="content">
    <div class="container-fluid">
      <div class="card card-outline card-primary shadow-sm">
        <div class="card-header">
          <h3 class="card-title">User Information</h3>
        </div>

        <div class="card-body">
          <div class="row mb-4 align-items-center">
            <div class="col-md-3 text-center">
              <% if (user.profile_image) { %>
                <img src="<%= process.env.BASE_URL + user.profile_image %>" alt="Profile Image" class="img-fluid rounded-circle border" style="width: 160px; height: 160px; object-fit: cover;">
              <% } else { %>
                <img src="/images/default-avatar.png" alt="Profile Image" class="img-fluid rounded-circle border" style="width: 160px; height: 160px; object-fit: cover;">
              <% } %>
            </div>

            <div class="col-md-9">
              <h4><%= user.first_name %> <%= user.last_name %></h4>
              <p class="mb-1"><strong>Email:</strong> <%= user.email %></p>
              <p class="mb-1"><strong>Phone:</strong> <%= user.phone || 'N/A' %></p>
              <p class="mb-1">
                <strong>Status:</strong>
                <% if (user.status === 'active') { %>
                  <span class="badge bg-success">Active</span>
                <% } else if (user.status === 'inactive') { %>
                  <span class="badge bg-secondary">Inactive</span>
                <% } else { %>
                  <span class="badge bg-danger">Banned</span>
                <% } %>
              </p>
            </div>
          </div>

          <hr>

          <div class="row mb-3">
            <div class="col-md-6">
              <h6><strong>Gender:</strong></h6>
              <p><%= user.gender || 'N/A' %></p>
            </div>
            <div class="col-md-6">
              <h6><strong>Date of Birth:</strong></h6>
              <p><%= user.dob || 'N/A' %></p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <h6><strong>Shoe Size:</strong></h6>
              <p><%= user.shoe_size || 'N/A' %></p>
            </div>
            <div class="col-md-6">
              <h6><strong>Referral Code:</strong></h6>
              <p><%= user.referral_code || 'N/A' %></p>
            </div>
          </div>

          <hr>

          <div class="row mb-3">
            <div class="col-md-6">
              <h6><strong>Address Line 1:</strong></h6>
              <p><%= user.address_1 || 'N/A' %></p>
            </div>
            <div class="col-md-6">
              <h6><strong>Address Line 2:</strong></h6>
              <p><%= user.address_2 || 'N/A' %></p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <h6><strong>City:</strong></h6>
              <p><%= user.city || 'N/A' %></p>
            </div>
            <div class="col-md-4">
              <h6><strong>State:</strong></h6>
              <p><%= user.state || 'N/A' %></p>
            </div>
            <div class="col-md-4">
              <h6><strong>Country:</strong></h6>
              <p><%= user.country || 'N/A' %></p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <h6><strong>Zip Code:</strong></h6>
              <p><%= user.zip_code || 'N/A' %></p>
            </div>
            <div class="col-md-4">
              <h6><strong>Latitude:</strong></h6>
              <p><%= user.latitude || 'N/A' %></p>
            </div>
            <div class="col-md-4">
              <h6><strong>Longitude:</strong></h6>
              <p><%= user.longitude || 'N/A' %></p>
            </div>
          </div>

          <% if (user.latitude && user.longitude) { %>
            <div class="mb-3">
              <h6><strong>Location Map:</strong></h6>
              <iframe
                width="100%"
                height="300"
                frameborder="0"
                style="border:0"
                referrerpolicy="no-referrer-when-downgrade"
                src="https://www.google.com/maps?q=<%= user.latitude %>,<%= user.longitude %>&hl=en&z=15&output=embed"
                allowfullscreen>
              </iframe>
            </div>
          <% } %>
        </div>

        <div class="card-footer text-end">
          <a href="/admin/users/edit/<%= user.id %>" class="btn btn-warning me-2">
            <i class="bi bi-pencil-square"></i> Edit
          </a>
          <button class="btn btn-danger delete-btn" data-id="<%= user.id %>">
            <i class="bi bi-trash"></i> Delete
          </button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const deleteButton = document.querySelector('.delete-btn');
    if (deleteButton) {
      deleteButton.addEventListener('click', async () => {
        const id = deleteButton.getAttribute('data-id');
        Swal.fire({
          title: 'Are you sure?',
          text: "You won't be able to revert this!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, delete it!'
        }).then(result => {
          if (result.isConfirmed) {
            fetch(`/admin/users/delete/${id}`, { method: 'DELETE' })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  Swal.fire('Deleted!', data.message, 'success');
                  setTimeout(() => window.location.href = '/admin/users', 1000);
                } else {
                  Swal.fire('Error', data.message, 'error');
                }
              })
              .catch(() => Swal.fire('Error', 'Something went wrong', 'error'));
          }
        });
      });
    }
  });
</script>

<%- include('../partials/footer') %>
